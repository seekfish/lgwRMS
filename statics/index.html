<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
	<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	
	<!-- 加载jquery -->
	<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
	<!-- 加载template -->
	<script src="./js/template.js"></script>
	<!-- 加载bootstrap插件 -->
	<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<!-- 加载分页插件 -->
	<script src="./js/jquery.pagination.js"></script>
	<!--  加载分页插件的css -->
	<link rel="stylesheet" type="text/css" href="./css/pagination.css">
	<!-- 引入cookie插件 -->
	<script src="./js/jquery.cookie.js"></script>
	<style type="text/css">
	*{
		margin: 0;padding:0;
	}
		header{
			position: relative;
		}
		header ul li a{
			color:white;
			font-size:12px;
			height: 40px;
			padding: 13px 15px;
		}
		header button{
			position: absolute;
			right:80px;
			top:3px;
			}
		header .ul2{
			position: absolute;
			right:100px;
		}
		main .box{
			overflow: hidden;
			margin: 10px 20px;
		}
		main .box p {
			display: line-height;
			height:34px;
			line-height: 34px;
			float: left;
		}
		main .box button{
			float: right;
		}
		.content .table	td{
			text-align: center;
		}
		header #login_btn{
			position: absolute;
			right:150px;
			top:3px;
		}
		#logo{
			position: relative;
		}
		#logo div input{
			position: absolute;
			left:100px;
			bottom: 0px;
		}
		#tem_wod tr{
		}
		#tem_wod tr td{
			border: 1px solid #ccc;
			max-width:100px;   
			vertical-align: middle;
		}
	</style>
</head>
<body>
	<header class="container" style="background: black;">
		<ul class="nav nav-pills" style=" float:left">
		  <li role="presentation"><a href="#" style="font-size: 16px;">拉勾网管理系统</a></li>
		  <li role="presentation"><a href="#" style="padding: 13px 15px;">首页</a></li>
		  <li role="presentation"><a href="#" style="padding: 13px 15px;">职位管理</a></li>
		</ul>
		<ul class="nav nav-pills ul2" style="float:right;display:none;" >
		  <li role="presentation" style="line-height: 42px;font-size: 12px;color: white">你好：<span id="yes">xxxx</span></li>
		  <li role="presentation"><a href="#" id="logout" style="padding: 13px 15px;">注销</a></li>
		</ul>
		 <button button type="button" class="btn btn-primary" id="login_btn" data-toggle="modal" data-target="#exampleModal" data-whatever="@getbootstrap">登录</button>
		 <button type="button" class="btn btn-primary" id="regist" data-toggle="modal" data-target="#exampleModal1" data-whatever="@mdo">注册</button>
	</header>
	<!-- //模态框 登录-->
			<div class="modal fade motai" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			        <h4 class="modal-title" id="exampleModalLabel">登录</h4>
			      </div>
			      <div class="modal-body">
			        <form>
			          <div class="form-group">
			            <label for="recipient-name" class="control-label">账号：</label>
			            <input type="text" class="form-control username" id="recipient-name">
			          </div>
			          <div class="form-group">
			            <label for="message-text" class="control-label">密码：</label>
			             <input type="password" class="form-control pwd">
			          </div>
			        </form>
			      </div>
			      <div class="modal-footer">
			        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
			        <button type="button" id="sure" class="btn btn-primary">确认</button>
			      </div>
			    </div>
			  </div>
		</div>
	<!-- //模态框 注册-->
			<div class="modal fade" id="exampleModal1" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			        <h4 class="modal-title" id="exampleModalLabel">用户注册</h4>
			      </div>
			      <div class="modal-body">
			        <form>
			          <div class="form-group">
			            <label for="recipient-name" class="control-label">用户名：</label>
			            <input type="text" class="form-control use_name">
			          </div>
			          <div class="form-group">
			            <label for="message-text" class="control-label ">密码：</label>
			            <input type="password" class="form-control pwd_1">
			          </div>
			          <div class="form-group">
			            <label for="message-text" class="control-label ">确认密码：</label>
			            <input type="password" class="form-control pwd_2">
			          </div>
			          <div class="form-group">
			            <label for="message-text" class="control-label">邮箱：</label>
			           <input type="email" class="form-control message">
			          </div>
			        </form>
			      </div>
			      <div class="modal-footer">
			        <button type="button" class="btn btn-primary regist_sure">确认</button>
			      </div>
			    </div>
			  </div>
			</div>
	<!-- 添加 -->
	<div class="modal fade" id="exampleModal2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="exampleModalLabel">职位信息</h4>
	      </div>
	      <div class="modal-body">
	        <form id='form1'>
	            <div class="form-group" id="logo">
		            <label for="recipient-name" class="control-label">公司logo</label>
		            <div>
		            	 <input type="file" id="InputFile">
					    <img id="showImg" class="imggg" src="" alt="" style="height:60px;width:60px">

		            </div>   
		        </div>
		        <div class="form-group">
		            <label for="recipient-name" class="control-label">职位名称</label>
		            <input type="text" class="form-control name" >
		        </div>
		        <div class="form-group">
		            <label for="recipient-name" class="control-label">公司名称</label>
		            <input type="text" class="form-control company_name" >
		        </div>
		        <div class="form-group">
		            <label for="recipient-name" class="control-label">工作经验</label>
		            <input type="text" class="form-control work" >
		        </div>
		        <div class="form-group">
		            <label for="recipient-name" class="control-label">职位类型</label>
		            <input type="text" class="form-control mold" >
		        </div>
          		<div class="form-group">
		            <label for="recipient-name" class="control-label">工作地点</label>
		            <input type="text" class="form-control address" >
		        </div>
		        <div class="form-group">
		            <label for="recipient-name" class="control-label">岗位薪资</label>
		            <input type="text" class="form-control pay" >
		        </div>
		        <p class="m_id" style="display: none" data-id=''></p>
		        </form>
		      		</div>
			      <div class="modal-footer">
			      	<button type="button"  style="display: none" class="btn btn-primary" id="res">修改</button>
			        <button type="button"  style="display: none" class="btn btn-primary" id="ensure">确认</button>
	      </div>
	    </div>
	  </div>
	</div>
	<main class="container main " style="display: none; >
		<!--  "-->
		<div class="box">
			<p>职位管理</p>
			<button type="button" class="btn btn-primary add" data-toggle="modal" data-target="#exampleModal2" data-whatever="@getbootstrap">添加</button>
		</div>
		<div class="content">
			<table class="table table-hover">
				<thead>
					 <tr>	  	
					  	<td>序号</td>
					  	<td>公司logo</td>
					  	<td>职位名称</td>
					  	<td>公司名称</td>
					  	<td>工作经验</td>
					  	<td>职位类型</td>
					  	<td>工作地点</td>
					  	<td>职位薪酬</td>
					  	<td>操作</td>
				  	</tr>
				</thead>
				<tbody id="tem_wod">
					
				</tbody>	 
			</table>
		</div>
			<!-- 分页插件 -->
<div class="m-style M-box" style="position: absolute; right:80px;bottom:40px;">
</div>
	</main>

<script type="text/javascript">
	var $login_btn=$("#login_btn"),
		$username=$(".username"),
		$pwd=$(".pwd"),
		$sure=$("#sure"),
		$yes=$("#yes"),
		$use_name=$('.use_name',$('.modal-body')),
		$pwd_1=$('.pwd_1',$('.modal-body')),
		$pwd_2=$('.pwd_2',$('.modal-body')),
		$message=$('.message',$('.modal-body'));
	// 点击登录
	$sure.on('click',function(){
		$("#exampleModal").show();
		$(".modal-backdrop").show();
		let parmas={};
		parmas.username=$username.val().trim();
		parmas.pwd=$pwd.val().trim();
		if(!parmas.username||!parmas.pwd){
			alert("不能为空")
			return
		}
		var username11=parmas.username
		$.post('/ss/login',parmas, function(data){
			if(data.code==0){
				//登录成功后显示
			$('main').show();
			$('.ul2').show();
			$yes.html(username11)
			$login_btn.hide();
			$('#regist').hide();
			$("#exampleModal").hide();
			$(".modal-backdrop").hide();
			//验证争取后放在cookie中
			$.cookie("_username",username11,{path:"/"});
			}else{
				alert('账号密码错误，请重新输入')
				return
			}
		})
	})
	//点击注销
	$("#logout").on("click",function(){
		$login_btn.show();
		$('.ul2').hide();
		$('#regist').show();
		$('main').hide();
		$.cookie("_username","",{path:"/"});
	})
	//点击注册
	$('.regist_sure').on('click',function(){
		var parmas={};
		parmas.username=$use_name.val();
		parmas.pwd=$pwd_1.val();
		parmas.message=$message.val();
		if(parmas.pwd!==$pwd_2.val()){
			alert("两次密码不一致");
		}else{
			$.post('/ss/regist',parmas,function(data){
				if(!data.code==0){
					alert(data.msg)
					return;
				}else{
					alert(data.msg)
					$('.ul2').show();
					$yes.html(parmas.username)
					$login_btn.hide();
					$('#regist').hide();
					$("#exampleModal1").hide();
					$(".modal-backdrop").hide();
				//成功以后显示
					$('main').show();
					$.cookie("_username",parmas.username,{path:"/"});
				}
			})
		}
		return false;
	})
//点击添加
	$(".add").on('click',function(){
		$("#ensure").show();
		$("#res").hide();
		$('#form1')[0].reset();
		$('.imggg').attr({src:""})
	})




//从cookie中取出数据
	var cookie=$.cookie('_username');
	if(cookie.length){
		$login_btn.hide();
		$('#regist').hide();
		$('.ul2').show();
		$yes.html(cookie)
		$('main').show();
	}
	
// 图片上传
	var a=null,
		oldImg=null;
	$('#InputFile').on('change',function(){
		oldImg=$(".td_img").attr('src');
		//判断是不是图片
		if(this.files[0].type=="image/jpeg"||this.files[0].type=="image/png"){
			//假表单提交
			var form=new FormData();
			form.append('upload',this.files[0]);	
			//利用异步处理
			$.ajax({
				url:"/upload",
				type:"POST",
				dataType:"json",
				data:form,
				contentType: false,
				processData: false
			}).done(function(data){
				$('#showImg').attr({src:data.img});
				//新的图片路径
				a=data.img;
			})
		}
		// //本地预览
		// let files=this.files,
		// url = window.URL.createObjectURL(files[0]) ;
		// $('#showImg').attr({src:url});
	})
//点击提交添加
	$("#ensure").on('click',function(){
		let pramas={
			name:$('.name').val(),
			company_name:$('.company_name').val(),
			work:$('.work').val(),
			mold:$('.mold').val(),
			address:$('.address').val(),
			pay:$('.pay').val(),
			img:$('.imggg').attr('src')
		}
		//利用异步处理
		// $.ajax({
		// 		url:"/upload",
		// 		type:"POST",
		// 		dataType:"json",
		// 		data:form,
		// 		contentType: false,
		// 		processData: false
		// 	}).done(function(data){
		// 		console.log(data)
		// 		$('#showImg').attr({src:data.img});
		// 		pramas.img=data.img;
		// 	}).done(function(){})
		//处理添加
		if(!pramas.company_name||!pramas.work||!pramas.mold||!pramas.address||!pramas.pay||!pramas.img||!pramas.name){
			alert("请准确输入")
			return
		}
			$.post('/ss/tj',pramas,function(data){
				if(!data.code==0){
					alert(data.msg)
				}else{
					$('#exampleModal2').hide();
					$(".modal-backdrop").hide();
				}
			}).done(function(){
				xianshi();
			}).done(function(){
				fanye();
			})
		return false;
	})
function xianshi(){
	//查询原来有多少职位显示5条
	$.post('/ss/old',function(data){
		//成功以后渲染
		let html=template('work_tem',data);
		$("#tem_wod").html(html)
	})
}
xianshi();
//删除
$("#tem_wod").on('click','.delete',function(){
	let a=$(this).parents("tr").find('._id').data('id'),
		b=$(this).parents("tr").find('.td_img').attr('src');
	$.post('/ss/delete',{_id:a},(data)=>{
		alert(data.msg);
		$("#tem_wod tr").remove();
	}).done(function(){
		xianshi();
	}).done(function(){
		fanye();
	}).done(function(){
	//删除图片
		$.post("/ss/deleteImg",{img:b},function(data){
			console.log("图片删除成功")
		})
	})
	return false;
})
//修改查找数据
let _index=null;
	$("#tem_wod").on('click','.amend',function(){
		$("#ensure").hide();
		$("#res").show();
		//获取当前数据
		let pramas={
			name:$(this).parents('tr').find('.td_name').html(),
			company_name:$(this).parents('tr').find('.td_company').html(),
			work:$(this).parents('tr').find('.td_work').html(),
			mold:$(this).parents('tr').find('.td_mold').html(),
			address:$(this).parents('tr').find('.td_address').html(),
			pay:$(this).parents('tr').find('.td_pay').html(),
			img:$(this).parents('tr').find('.td_img').attr('src'),
			_id:$(this).parents('tr').find('._id').data('id')
		}
			_index=$(this).parents('tr').find('.prd_id').html().trim();
		//把数据传给模态框
			$('.name').val(pramas.name),
			$('.company_name').val(pramas.company_name),
			$('.work').val(pramas.work),
			$('.mold').val(pramas.mold),
			$('.address').val(pramas.address),
			$('.pay').val(pramas.pay),
			$('.imggg').attr({src:pramas.img})
			$('.m_id').data({"id":pramas._id});
	})
//确认修改
	$('#res').on('click',function(){
		let pramas={
			name:$('.name').val(),
			company_name:$('.company_name').val(),
			work:$('.work').val(),
			mold:$('.mold').val(),
			address:$('.address').val(),
			pay:$('.pay').val(),
			img:a,
			_id:$('.m_id').data('id'),
		}
		//提交到后台
		var html=null;
		$.post('/ss/amend',pramas,function(data){
			if(!data.code==0){
				alert("修改失败，请稍后重试");
			}
			//拿到数据以后渲染
			html=template('work_tem',data);
			let a=$("#tem_wod").find(`._id[data-id=${pramas._id}]`).parents("tr");
			a.replaceWith(html);
			let b=$("#tem_wod").find(`._id[data-id=${pramas._id}]`).parents("tr").find('.prd_id').html(_index);
			$('#exampleModal2').hide();
		    $(".modal-backdrop").hide();
		   	$('#form1')[0].reset();
		}).done(function(){
			$.post("/ss/deleteImg",{img:oldImg},function(data){
			console.log("图片删除成功")
			})
		})
		return false;
	})
// 模板
</script>
	<script type="text/html" id="work_tem">
		{{each list as prod i}}
		<tr>	  	
		  	<td class="prd_id">{{(index-1)*5+i+1}}</td>
		  	<td><img src="{{prod.img}}" class="td_img" style="height:50px;"></td>
		  	<td class="td_name">{{prod.name}}</td>
		  	<td class="td_company">{{prod.company_name}}</td>
		  	<td class="td_work">{{prod.work}}</td>
		  	<td class="td_mold">{{prod.mold}}</td>
		  	<td class="td_address">{{prod.address}}</td>
		  	<td class="td_pay">{{prod.pay}}</td>
		  	<td><a href="#" class="amend" data-toggle="modal" data-target="#exampleModal2" data-whatever="@getbootstrap">修改</a> |
		  		<a href="#" class="delete">删除</a>
		  	</td>
		  	<td class="_id" style="display: none" data-id="{{prod._id}}"></td>
	  	</tr>
	{{/each}}
</script>
<script type="text/javascript">
function fanye(){
	//获取当前数据库有多少内容
	$.post('/ss/all',function(data){
		let a=data.list.length;
		if(!a){a=1}
		$('.M-box').pagination({
		    totalData: a,
		    showData: 5,
		    coping: true
		});
	}).done(function(){
		//点击翻页
		let index=1;
		$('.M-box').on('click','a',function(){
			if($(this).hasClass("next")){
				index++;
			}else if($(this).hasClass("prev")){
				index--;
				if(index<=0){
					index=1;
				}
			}else {
				index=$(this).data("page")
			}
			$.post('/ss/fanye',{index},function(data){
			let html=template('work_tem',data);
				$("#tem_wod").html(html)
			})
		})
	})
}
fanye();
</script>
</body>
</html>